{% extends 'hod/hbase.html' %}

{% block title %}Attendance Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/college-dashboard.css') }}">
<style>
    .division-card {
        border-radius: 10px;
        border-left: 4px solid #0d6efd;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .subject-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .subject-faculty {
        font-size: 0.85rem;
        color: #666;
    }

    .next-lecture-date {
        font-weight: 600;
        color: #0d6efd;
    }

    .attendance-filters {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .badge-soft {
        font-weight: 500;
        padding: 6px 12px;
    }

    .bg-success-soft {
        background-color: #d4edda;
    }

    .text-success {
        color: #155724;
    }

    .bg-danger-soft {
        background-color: #f8d7da;
    }

    .text-danger {
        color: #721c24;
    }

    .btn-premium {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-weight: 600;
    }

    .btn-premium:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
    }

    @media print {
        @page {
            size: A4 portrait;
            margin: 10mm;
        }

        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Hide non-essential elements */
        .sidebar,
        .navbar,
        .attendance-filters,
        .btn-group,
        button,
        .btn {
            display: none !important;
        }

        .container-fluid {
            padding: 0 !important;
        }

        /* Page header */
        .page-title {
            font-size: 18pt;
            margin-bottom: 5px;
        }

        .text-muted {
            font-size: 9pt;
        }

        /* Division cards */
        .division-card {
            page-break-inside: avoid;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            border: 1px solid #ddd;
            padding: 15px !important;
            margin-bottom: 10px;
        }

        .division-card h5 {
            font-size: 12pt;
        }

        .subject-item {
            font-size: 9pt;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .subject-faculty {
            font-size: 8pt;
        }

        .next-lecture-date {
            font-size: 9pt;
        }

        /* Responsive columns to fit A4 */
        .col-lg-6 {
            width: 100% !important;
            padding: 0 5px !important;
        }

        .row {
            margin: 0 !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="main-content">
        <div class="container-fluid p-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="page-title mb-0">Attendance Management</h1>
                    <p class="text-muted">Mark and manage attendance for:
                        <strong>{{ context.department.dept_name if context.department else 'Department' }}</strong>
                    </p>
                </div>
            </div>

            <!-- Attendance Selection Filters -->
            <div class="attendance-filters">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-600">Division</label>
                        <select class="form-select" id="divisionSelect" onchange="loadSubjectsForDivision()">
                            <option value="">-- Select Division --</option>
                            {% if divisions %}
                            {% for div in divisions %}
                            <option value="{{ div.div_id }}">{{ div.division_name }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-600">Subject</label>
                        <select class="form-select" id="subjectSelect">
                            <option value="">-- Select Subject --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-600">Lecture Date</label>
                        <input type="date" class="form-control" id="lectureDate"
                            value="{{ datetime.now().strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-premium w-100" id="btnMarkAttendance" onclick="openAttendanceModal()"
                            disabled>
                            <i class="fas fa-clipboard-list me-2"></i>Mark Attendance
                        </button>
                    </div>
                </div>
            </div>

            <!-- Attendance Modal -->
            <div class="modal fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header bg-gradient text-white p-4"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div>
                                <h5 class="modal-title fw-bold" id="attendanceModalLabel">Mark Attendance</h5>
                                <p class="mb-0 small opacity-75" id="modalSubjectInfo"></p>
                            </div>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-0">
                            <div class="bg-light p-3 d-flex justify-content-between align-items-center border-bottom">
                                <span class="text-muted small">Toggle attendance status for each student</span>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-danger rounded-pill"
                                        onclick="markAllAbsent()">
                                        Mark All Absent
                                    </button>
                                    <button class="btn btn-sm btn-outline-success rounded-pill"
                                        onclick="markAllPresent()">
                                        All Present
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light sticky-top">
                                        <tr>
                                            <th class="ps-4">Roll No</th>
                                            <th>Student Name</th>
                                            <th class="text-center">Status</th>
                                            <th class="pe-4 text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentListBody">
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer bg-light p-3">
                            <button type="button" class="btn btn-link text-muted text-decoration-none me-auto"
                                data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-premium px-4" onclick="saveAttendance()">
                                <i class="fas fa-save me-2"></i>Save Attendance
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Divisions with Subjects -->
            {% if divisions %}
            <div class="row">
                {% for division in divisions %}
                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="division-card p-4">
                        <!-- Division Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="fw-bold mb-0">{{ division.division_name }}</h5>
                                <small class="text-muted">Division ID: {{ division.div_id }}</small>
                            </div>
                        </div>

                        <!-- Subjects -->
                        <div class="mb-3">
                            <label class="small fw-bold mb-2 d-block">Subjects Taught:</label>
                            {% if division.subjects %}
                            {% for subject in division.subjects %}
                            <div class="subject-item">
                                <div>
                                    <strong>{{ subject.code }}</strong> - {{ subject.name }}
                                    <div class="subject-faculty">Faculty: {{ subject.faculty }}</div>
                                </div>
                                <div class="text-end">
                                    <div class="next-lecture-date">{{ subject.next_lecture }}</div>
                                    <small class="text-muted">Next Lecture</small>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted small">No subjects assigned</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No divisions found for your department. <a href="/hod/dashboard">Go to Dashboard</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const divisionData = {{ divisions|default ([], true) | tojson | safe }};
    let currentStudents = [];
    let attendanceStatus = {};

    // Load subjects for selected division
    function loadSubjectsForDivision() {
        const divisionId = document.getElementById('divisionSelect').value;
        const subjectSelect = document.getElementById('subjectSelect');

        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        checkFormComplete();

        if (!divisionId) return;

        const division = divisionData.find(d => d.div_id == divisionId);
        if (division && division.subjects) {
            division.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                subjectSelect.appendChild(option);
            });
        }
    }

    // Check if form is complete
    document.getElementById('subjectSelect').addEventListener('change', checkFormComplete);

    function checkFormComplete() {
        const divId = document.getElementById('divisionSelect').value;
        const subjectId = document.getElementById('subjectSelect').value;
        const btn = document.getElementById('btnMarkAttendance');

        btn.disabled = !(divId && subjectId);
    }

    // Open attendance modal
    async function openAttendanceModal() {
        const divisionId = document.getElementById('divisionSelect').value;
        const subjectId = document.getElementById('subjectSelect').value;
        const lectureDate = document.getElementById('lectureDate').value;

        if (!divisionId || !subjectId) {
            alert('Please select division and subject');
            return;
        }

        try {
            // Fetch students for this division
            const response = await fetch(`/hod/attendance/students/${divisionId}`);
            if (!response.ok) throw new Error('Failed to fetch students');

            const data = await response.json();
            currentStudents = data.students || [];

            if (currentStudents.length === 0) {
                alert('No students found in this division');
                return;
            }

            // Initialize attendance status
            attendanceStatus = {};
            currentStudents.forEach(student => {
                attendanceStatus[student.student_id] = 'PRESENT';
            });

            // Update modal header
            const division = divisionData.find(d => d.div_id == divisionId);
            const subject = division.subjects.find(s => s.id == subjectId);
            document.getElementById('modalSubjectInfo').textContent =
                `${division.division_name} - ${subject.name} (${lectureDate})`;

            loadStudents();
            const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
            modal.show();
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to load students');
        }
    }

    // Load students in table
    function loadStudents() {
        const listBody = document.getElementById('studentListBody');
        listBody.innerHTML = '';

        const sortedStudents = [...currentStudents].sort((a, b) => {
            const rollA = parseInt(a.roll_no) || 0;
            const rollB = parseInt(b.roll_no) || 0;
            return rollA - rollB;
        });

        sortedStudents.forEach(student => {
            const status = attendanceStatus[student.student_id] || 'PRESENT';
            const isPresent = status === 'PRESENT';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="ps-4 fw-medium text-muted">${student.roll_no || 'N/A'}</td>
                <td class="fw-bold">${student.name}</td>
                <td class="text-center">
                    <span id="badge-${student.student_id}" class="badge rounded-pill badge-soft ${isPresent ? 'bg-success-soft text-success' : 'bg-danger-soft text-danger'}">
                        ${status}
                    </span>
                </td>
                <td class="pe-4 text-end">
                    <button type="button" class="btn btn-sm ${isPresent ? 'btn-outline-danger' : 'btn-outline-success'} rounded-pill" 
                        onclick="toggleStudent(${student.student_id})">
                        ${isPresent ? 'Mark Absent' : 'Mark Present'}
                    </button>
                </td>
            `;
            listBody.appendChild(row);
        });
    }

    // Toggle attendance for a student
    function toggleStudent(studentId) {
        const isPresent = attendanceStatus[studentId] === 'PRESENT';
        attendanceStatus[studentId] = isPresent ? 'ABSENT' : 'PRESENT';

        const badge = document.getElementById(`badge-${studentId}`);
        const btn = badge.parentElement.nextElementSibling.querySelector('button');

        if (isPresent) {
            badge.textContent = 'ABSENT';
            badge.className = 'badge rounded-pill badge-soft bg-danger-soft text-danger';
            btn.textContent = 'Mark Present';
            btn.className = 'btn btn-sm btn-outline-success rounded-pill';
        } else {
            badge.textContent = 'PRESENT';
            badge.className = 'badge rounded-pill badge-soft bg-success-soft text-success';
            btn.textContent = 'Mark Absent';
            btn.className = 'btn btn-sm btn-outline-danger rounded-pill';
        }
    }

    // Mark all present
    function markAllPresent() {
        currentStudents.forEach(student => {
            attendanceStatus[student.student_id] = 'PRESENT';
        });
        loadStudents();
    }

    // Mark all absent
    function markAllAbsent() {
        currentStudents.forEach(student => {
            attendanceStatus[student.student_id] = 'ABSENT';
        });
        loadStudents();
    }

    // Save attendance
    async function saveAttendance() {
        const divisionId = document.getElementById('divisionSelect').value;
        const subjectId = document.getElementById('subjectSelect').value;
        const lectureDate = document.getElementById('lectureDate').value;

        const attendanceData = Object.keys(attendanceStatus).map(studentId => ({
            student_id: parseInt(studentId),
            status: attendanceStatus[studentId]
        }));

        try {
            const response = await fetch('/hod/attendance/mark', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    division_id: divisionId,
                    subject_id: subjectId,
                    lecture_date: lectureDate,
                    attendance: attendanceData
                })
            });

            const result = await response.json();
            if (result.success) {
                alert('Attendance saved successfully!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('attendanceModal'));
                modal.hide();
            } else {
                alert('Error: ' + (result.message || 'Failed to save attendance'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save attendance');
        }
    }
</script>
{% endblock %}