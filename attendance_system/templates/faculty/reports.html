{% extends 'faculty/fbase.html' %}

{% block title %}Attendance Reports{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/college-dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/faculty.css') }}">
<style>
    .reports-container {
        overflow-x: auto;
        padding: 20px 0;
    }

    .reports-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 0.85rem;
    }

    .reports-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .reports-table th {
        padding: 12px 8px;
        text-align: center;
        white-space: nowrap;
        border: 1px solid #e0e0e0;
        font-weight: 600;
    }

    .reports-table td {
        padding: 10px 8px;
        border: 1px solid #e0e0e0;
        text-align: center;
    }

    .reports-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .reports-table tbody tr:hover {
        background-color: #f5f5f5;
    }

    .reports-table tbody tr:nth-child(even) {
        background-color: #fafafa;
    }

    /* Student info columns - left aligned and sticky */
    .student-col-roll,
    .student-col-div,
    .student-col-name,
    .student-col-enrollment,
    .student-col-branch,
    .student-col-mentor {
        text-align: left;
    }

    .student-info-wrapper {
        position: sticky;
        left: 0;
        background: white;
        z-index: 5;
        min-width: 400px;
        display: flex;
        gap: 8px;
    }

    .student-col-roll {
        min-width: 50px;
        font-weight: bold;
        color: #667eea;
    }

    .student-col-div {
        min-width: 40px;
        color: #666;
    }

    .student-col-branch {
        min-width: 60px;
        color: #666;
    }

    .student-col-enrollment {
        min-width: 90px;
        color: #666;
    }

    .student-col-name {
        min-width: 100px;
        color: #333;
        font-weight: 500;
    }

    .student-col-mentor {
        min-width: 80px;
        color: #666;
    }

    /* Subject columns styling */
    .subject-column {
        min-width: 140px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .subject-header {
        font-weight: 700;
        color: white;
        padding-bottom: 8px;
    }

    .subject-subheader {
        font-size: 0.75rem;
        font-weight: 500;
        opacity: 0.9;
        padding-top: 8px;
    }

    .attendance-percent {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        min-width: 50px;
    }

    .attendance-percent.excellent {
        background-color: #d4edda;
        color: #155724;
    }

    .attendance-percent.good {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .attendance-percent.warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .attendance-percent.danger {
        background-color: #f8d7da;
        color: #721c24;
    }

    .total-column {
        background-color: #f0f0f0;
        font-weight: bold;
        color: #333;
    }

    .overall-column {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: bold;
        position: sticky;
        right: 0;
        z-index: 5;
        min-width: 100px;
    }

    .report-header {
        margin-bottom: 30px;
    }

    .report-header h2 {
        color: #333;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .report-header p {
        color: #666;
        margin: 0;
    }

    .report-filters {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filter-group {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
        flex-grow: 1;
        min-width: 150px;
    }

    .filter-item label {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }

    .filter-item input,
    .filter-item select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .btn-group {
        display: flex;
        gap: 10px;
    }

    .btn-export {
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s;
        white-space: nowrap;
    }

    .btn-export:hover {
        background-color: #218838;
    }

    .btn-print {
        padding: 10px 20px;
        background-color: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s;
        white-space: nowrap;
    }

    .btn-print:hover {
        background-color: #5568d3;
    }

    .legend {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        font-size: 0.85rem;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 3px;
    }

    @media (max-width: 768px) {
        .student-info-wrapper {
            min-width: 300px;
        }

        .reports-table th,
        .reports-table td {
            padding: 8px 4px;
            font-size: 0.75rem;
        }

        .subject-column {
            min-width: 100px;
        }

        .filter-group {
            flex-direction: column;
        }

        .filter-item {
            min-width: 100%;
        }

        .btn-group {
            flex-direction: column;
            width: 100%;
        }

        .btn-export,
        .btn-print {
            width: 100%;
        }
    }

    @media print {

        .report-filters,
        .btn-group {
            display: none;
        }

        .reports-table {
            box-shadow: none;
            page-break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="main-content">
        <div class="container-fluid p-4">
            <!-- Header -->
            <div class="report-header">
                <h2><i class="fas fa-file-alt me-2"></i>Attendance Reports</h2>
                <p class="text-muted">Comprehensive subjectwise attendance compilation for all students</p>
            </div>

            <!-- Filters -->
            <div class="report-filters">
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="divisionFilter">Filter by Division:</label>
                        <select id="divisionFilter" onchange="filterReports()">
                            <option value="">All Divisions</option>
                            {% set divisions = students|map(attribute='division_name')|unique|list %}
                            {% for div in divisions %}
                            <option value="{{ div }}">{{ div }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-item" style="flex-grow: 2;">
                        <label for="searchStudent">Search Student:</label>
                        <input type="text" id="searchStudent" placeholder="Enter name or roll no..."
                            onkeyup="filterReports()">
                    </div>
                    <div class="btn-group">
                        <button class="btn-export" onclick="exportToCSV()">
                            <i class="fas fa-download me-1"></i>Export CSV
                        </button>
                        <button class="btn-export" onclick="location.href='/faculty/export/csv'">
                            <i class="fas fa-file-excel me-1"></i>Compiled Report CSV
                        </button>
                        <button class="btn-export" onclick="location.href='/faculty/export/pdf'">
                            <i class="fas fa-file-pdf me-1"></i>Compiled Report PDF
                        </button>
                        <button class="btn-print" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background-color: #d4edda;"></div>
                        <span>Excellent (â‰¥85%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background-color: #d1ecf1;"></div>
                        <span>Good (75-84%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background-color: #fff3cd;"></div>
                        <span>Warning (60-74%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background-color: #f8d7da;"></div>
                        <span>At Risk (<60%)< /span>
                    </div>
                </div>
            </div>

            <!-- Reports Table -->
            <div class="reports-container">
                <table class="reports-table" id="reportsTable">
                    <thead>
                        <tr>
                            <!-- Student Info Headers -->
                            <th class="student-col-roll">Roll No</th>
                            <th class="student-col-div">Div</th>
                            <th class="student-col-branch">Branch</th>
                            <th class="student-col-enrollment">Enrollment No</th>
                            <th class="student-col-name">Name</th>
                            <th class="student-col-mentor">Mentor</th>

                            <!-- Subject Headers -->
                            {% for subject in subjects %}
                            <th colspan="2" class="subject-column">
                                <div class="subject-header">{{ subject }}</div>
                            </th>
                            {% endfor %}

                            <!-- Overall Column -->
                            <th colspan="2" class="overall-column">OVERALL</th>
                        </tr>
                        <tr>
                            <!-- Empty cells for student info -->
                            <th colspan="6" style="border: none;"></th>

                            <!-- Subject Sub-headers (Total & %) -->
                            {% for subject in subjects %}
                            <th style="text-align: center; border-top: none; padding-top: 0; font-size: 0.8rem;">Total
                            </th>
                            <th style="text-align: center; border-top: none; padding-top: 0; font-size: 0.8rem;">%</th>
                            {% endfor %}

                            <!-- Overall Sub-headers -->
                            <th style="text-align: center; border-top: none; padding-top: 0; font-size: 0.8rem;">Total
                            </th>
                            <th style="text-align: center; border-top: none; padding-top: 0; font-size: 0.8rem;">%</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        {% for student in students %}
                        <tr class="student-row" data-roll="{{ student.roll_no }}" data-name="{{ student.name }}"
                            data-division="{{ student.division_name }}">
                            <!-- Student Info -->
                            <td class="student-col-roll">{{ student.roll_no }}</td>
                            <td class="student-col-div">{{ student.division_name }}</td>
                            <td class="student-col-branch">{{ student.dept_name }}</td>
                            <td class="student-col-enrollment">{{ student.enrollment_no }}</td>
                            <td class="student-col-name"><strong>{{ student.name }}</strong></td>
                            <td class="student-col-mentor">{{ student.mentor_name }}</td>

                            <!-- Subject Attendance Data -->
                            {% for subject in subjects %}
                            {% if subject in student.subjectwise_attendance %}
                            {% set attendance = student.subjectwise_attendance[subject] %}
                            <td class="total-column">{{ attendance.attended_lectures }}/{{ attendance.total_lectures }}
                            </td>
                            <td>
                                <span
                                    class="attendance-percent {% if attendance.attendance_percentage >= 85 %}excellent{% elif attendance.attendance_percentage >= 75 %}good{% elif attendance.attendance_percentage >= 60 %}warning{% else %}danger{% endif %}">
                                    {{ "%.1f"|format(attendance.attendance_percentage) }}%
                                </span>
                            </td>
                            {% else %}
                            <td class="total-column">-</td>
                            <td><span class="attendance-percent">-</span></td>
                            {% endif %}
                            {% endfor %}

                            <!-- Overall Attendance -->
                            <td class="overall-column">{{ student.attended_lectures }}/{{ student.total_lectures }}</td>
                            <td class="overall-column">
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;">
                                    {{ "%.1f"|format(student.overall_attendance) }}%
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if not students %}
            <div class="alert alert-info mt-4" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No Data Available</strong><br>
                No attendance records found. Please ensure attendance has been marked for students.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function filterReports() {
        const divisionFilter = document.getElementById('divisionFilter').value.toLowerCase();
        const searchFilter = document.getElementById('searchStudent').value.toLowerCase();
        const rows = document.querySelectorAll('#reportTableBody .student-row');

        rows.forEach(row => {
            const rollNo = row.getAttribute('data-roll').toLowerCase();
            const name = row.getAttribute('data-name').toLowerCase();
            const division = row.getAttribute('data-division').toLowerCase();

            const divisionMatch = !divisionFilter || division.includes(divisionFilter);
            const searchMatch = !searchFilter || rollNo.includes(searchFilter) || name.includes(searchFilter);

            row.style.display = divisionMatch && searchMatch ? '' : 'none';
        });
    }

    function exportToCSV() {
        const table = document.getElementById('reportsTable');
        let csv = [];

        // Get headers
        const headers = [];

        // Student info columns
        const studentHeaders = ['Roll No', 'Division', 'Branch', 'Enrollment No', 'Name', 'Mentor'];
        headers.push(...studentHeaders);

        // Subject headers - get from visible rows
        const subjects = [];
        table.querySelectorAll('thead tr:first-child th.subject-column').forEach(th => {
            const text = th.textContent.trim();
            if (text && text !== 'OVERALL') {
                subjects.push(text);
            }
        });

        subjects.forEach(subject => {
            headers.push(subject + ' (Total)');
            headers.push(subject + ' (%)');
        });

        headers.push('Overall (Total)');
        headers.push('Overall (%)');

        csv.push('"' + headers.join('","') + '"');

        // Get data rows
        document.querySelectorAll('#reportTableBody .student-row').forEach(row => {
            if (row.style.display !== 'none') {
                const rowData = [];
                row.querySelectorAll('td').forEach(td => {
                    const text = td.textContent.trim();
                    rowData.push(`"${text}"`);
                });
                csv.push(rowData.join(','));
            }
        });

        // Download
        const csvContent = 'data:text/csv;charset=utf-8,' + csv.join('\n');
        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csvContent));
        link.setAttribute('download', `attendance_report_${new Date().toISOString().slice(0, 10)}.csv`);
        link.click();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Reports page loaded');
    });
</script>
{% endblock %}