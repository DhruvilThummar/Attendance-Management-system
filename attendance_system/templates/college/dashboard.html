{% extends 'college/cbase.html' %}

{% block title %}College Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/college-dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="main-content">

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <div class="container p-4">
                <!-- Welcome Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h1 class="page-title">Dashboard</h1>
                        <p class="text-muted">Manage departments, divisions, faculty, and view analytics</p>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-gradient-indigo">
                                <i class="fas fa-building" title="Departments Icon"></i>
                            </div>
                            <div class="stat-content">
                                <h5>Departments</h5>
                                <h3>{{ departments|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-gradient-rose">
                                <i class="fas fa-door-open" title="Divisions Icon"></i>
                            </div>
                            <div class="stat-content">
                                <h5>Divisions</h5>
                                <h3>{{ divisions|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-gradient-azure">
                                <i class="fas fa-chalkboard-teacher" title="Faculty Icon"></i>
                            </div>
                            <div class="stat-content">
                                <h5>Faculty</h5>
                                <h3>{{ faculty_count }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-gradient-sunset">
                                <i class="fas fa-user-graduate" title="Students Icon"></i>
                            </div>
                            <div class="stat-content">
                                <h5>Students</h5>
                                <h3>{{ student_count }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="quick-actions">
                            <h5 class="mb-3">Quick Actions</h5>
                            <div class="action-buttons">
                                <a href="/college/departments" class="action-btn btn-primary">
                                    <i class="fas fa-building me-2"></i>Manage Departments
                                </a>
                                <a href="/college/divisions" class="action-btn btn-info">
                                    <i class="fas fa-door-open me-2"></i>Manage Divisions
                                </a>
                                <a href="/college/faculty" class="action-btn btn-success">
                                    <i class="fas fa-chalkboard-teacher me-2"></i>View Faculty
                                </a>
                                <a href="/college/students" class="action-btn btn-warning">
                                    <i class="fas fa-user-graduate me-2"></i>View Students
                                </a>
                                <a href="/college/attendance-analytics" class="action-btn btn-danger">
                                    <i class="fas fa-chart-bar me-2"></i>Attendance Analytics
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Summary Tables (Side by Side) -->
                <div class="row mb-4">
                    <!-- Students by Department -->
                    <div class="col-lg-6 col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Students by Department</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Department</th>
                                                <th>Count</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for dept in departments %}
                                            <tr class="dept-stats-row" data-dept-id="{{ dept.dept_id }}">
                                                <td><strong>{{ dept.dept_name }}</strong></td>
                                                <td><span class="badge bg-info">{{ dept.student_count }}</span></td>
                                                <td>
                                                    {% set dept_pct = (dept.student_count/student_count*100)|int if
                                                    student_count > 0 else 0 %}
                                                    <div class="progress progress-modern student-progress-container"
                                                        title="{{ dept.student_count }} students ({{ dept_pct }}%)">
                                                        <div class="progress-bar bg-info sync-progress"
                                                            role="progressbar" data-now="{{ dept_pct }}"
                                                            aria-valuemin="0" aria-valuemax="100"
                                                            aria-label="{{ dept.dept_name }} percentage"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Students by Division -->
                    <div class="col-lg-6 col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Students by Division</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Division</th>
                                                <th>Count</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for dept in departments %}
                                            {% for div in dept.divisions %}
                                            <tr class="student-stats-row" data-dept-id="{{ dept.dept_id }}"
                                                data-div-id="{{ div.div_id }}">
                                                <td><strong>{{ div.division_name }}</strong> ({{ dept.dept_name }})</td>
                                                <td><span class="badge bg-warning">{{ div.student_count }}</span></td>
                                                <td>
                                                    {% set div_pct = (div.student_count/student_count*100)|int if
                                                    student_count > 0 else 0 %}
                                                    <div class="progress progress-modern student-progress-container-sm"
                                                        title="{{ div.student_count }} students ({{ div_pct }}%)">
                                                        <div class="progress-bar bg-warning sync-progress"
                                                            role="progressbar" data-now="{{ div_pct }}"
                                                            aria-valuemin="0" aria-valuemax="100"
                                                            aria-label="{{ div.division_name }} percentage">
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Division Overview Cards (Side by Side) -->
                <div class="row" id="divisionCardsRow">
                    {% for dept in departments %}
                    {% for div in dept.divisions %}
                    <div class="col-lg-6 col-md-6 mb-4 dashboard-div-card-container" data-dept-id="{{ dept.dept_id }}"
                        data-div-id="{{ div.div_id }}">
                        <div class="division-card h-100">
                            <div class="division-header bg-gradient-rose">
                                <h4 class="div-name-text">{{ div.division_name }}</h4>
                                <p class="division-code">{{ div.division_code }}</p>
                            </div>
                            <div class="division-body">
                                <div class="div-info-row">
                                    <span class="info-label">Department:</span>
                                    <span>{{ dept.dept_name }}</span>
                                </div>
                                <div class="div-info-row">
                                    <span class="info-label">Capacity:</span>
                                    <span class="badge bg-info">{{ div.capacity }}</span>
                                </div>
                                <div class="div-info-row">
                                    <span class="info-label">Current Students:</span>
                                    <span class="badge bg-warning">{{ div.student_count }}</span>
                                </div>
                                <div class="div-info-row">
                                    <span class="info-label">Class Teacher:</span>
                                    <span>{{ div.class_teacher or 'Not Assigned' }}</span>
                                </div>
                            </div>
                            <div class="division-footer">
                                <a href="/college/divisions/{{ div.div_id }}/details"
                                    class="btn btn-sm btn-outline-info w-100"
                                    title="View division {{ div.division_name }} details">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/college-dashboard.js') }}"></script>
<script>
    function syncDashboard() {
        const selectedDept = localStorage.getItem('selectedDept');
        const selectedDiv = localStorage.getItem('selectedDiv');

        // 1. Filter Recent Departments and Dept Stats
        document.querySelectorAll('.dept-summary-row, .dept-stats-row').forEach(row => {
            const deptId = row.dataset.deptId;
            row.style.display = (!selectedDept || deptId === selectedDept) ? 'table-row' : 'none';
        });

        // 2. Filter Student Stats by Division
        document.querySelectorAll('.student-stats-row').forEach(row => {
            const deptId = row.dataset.deptId;
            const divId = row.dataset.divId;
            const deptMatch = !selectedDept || deptId === selectedDept;
            const divMatch = !selectedDiv || divId === selectedDiv;
            row.style.display = (deptMatch && divMatch) ? 'table-row' : 'none';
        });

        // 3. Filter Division Cards
        document.querySelectorAll('.dashboard-div-card-container').forEach(card => {
            const deptId = card.dataset.deptId;
            const divId = card.dataset.divId;
            const deptMatch = !selectedDept || deptId === selectedDept;
            const divMatch = !selectedDiv || divId === selectedDiv;
            card.style.display = (deptMatch && divMatch) ? 'block' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', syncDashboard);
    window.addEventListener('departmentSelected', syncDashboard);
    window.addEventListener('divisionSelected', syncDashboard);
</script>
{% endblock %}